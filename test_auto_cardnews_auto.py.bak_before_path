#!/usr/bin/env python3
"""
ìë™í™” ì¹´ë“œë‰´ìŠ¤ ìƒì„± í…ŒìŠ¤íŠ¸ (ìë™ ì‹¤í–‰ ë²„ì „)
"""
import json
import os
from datetime import datetime
from anthropic import Anthropic
from dotenv import load_dotenv

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

def load_pending_articles():
    """ëŒ€ê¸° ì¤‘ì¸ ê¸°ì‚¬ ë¡œë“œ"""
    with open('pending_cardnews.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def generate_cardnews_with_claude(article):
    """Claude APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹´ë“œë‰´ìŠ¤ ìƒì„±"""
    
    # Claude API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    api_key = os.getenv('ANTHROPIC_API_KEY')
    if not api_key:
        print("âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None
    
    client = Anthropic(api_key=api_key)
    
    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    title = article['title']
    keywords = ', '.join(article.get('keywords', []))
    content = article.get('content', '')
    
    # ìƒ‰ìƒ í…Œë§ˆ ê²°ì •
    color_map = {
        'ì¬ìƒì—ë„ˆì§€': '#10B981',
        'íƒœì–‘ê´‘': '#10B981',
        'í’ë ¥': '#10B981',
        'VPP': '#06B6D4',
        'ì „ë ¥ì¤‘ê°œ': '#06B6D4',
        'ESS': '#8B5CF6',
        'ì „ë ¥ì €ì¥': '#8B5CF6',
        'ì „ë ¥ì‹œì¥': '#3B82F6',
        'ì •ì±…': '#3B82F6',
        'ì „ë ¥ë§': '#1E40AF',
        'ì¸í”„ë¼': '#1E40AF'
    }
    
    primary_color = '#8B5CF6'  # ESS ê´€ë ¨ì´ë¯€ë¡œ í¼í”Œ
    for keyword in article.get('keywords', []):
        if keyword in color_map:
            primary_color = color_map[keyword]
            break
    
    prompt = f"""ë‹¹ì‹ ì€ ì „ë ¥ ì‚°ì—… ì „ë¬¸ ì¹´ë“œë‰´ìŠ¤ ë””ìì´ë„ˆì…ë‹ˆë‹¤. ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ Enhanced ìŠ¤íƒ€ì¼ì˜ 5í˜ì´ì§€ HTML ì¹´ë“œë‰´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

[ê¸°ì‚¬ ì •ë³´]
ì œëª©: {title}
í‚¤ì›Œë“œ: {keywords}
ë‚´ìš©: {content}
ì£¼ìš” ìƒ‰ìƒ: {primary_color}

[Enhanced ìŠ¤íƒ€ì¼ ê°€ì´ë“œ]
1. Pretendard í°íŠ¸ ì‚¬ìš© (CDN: https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css)
2. 5ê°œ ì„¹ì…˜ êµ¬ì¡°: 
   - ì„¹ì…˜ 1: í•µì‹¬ ì¸ì‚¬ì´íŠ¸ (ëˆˆê¸¸ì„ ë„ëŠ” í—¤ë“œë¼ì¸ + 3ì¤„ í•µì‹¬ ìš”ì•½)
   - ì„¹ì…˜ 2: ì£¼ìš” í†µê³„/ìˆ˜ì¹˜ (ì¸í¬ê·¸ë˜í”½, ì°¨íŠ¸)
   - ì„¹ì…˜ 3: íƒ€ì„ë¼ì¸/ë°œì „ ê³¼ì • (ì‹œê°ì  íƒ€ì„ë¼ì¸)
   - ì„¹ì…˜ 4: ì „ë¬¸ê°€ ì˜ê²¬/ì‹œì‚¬ì  (ì¸ìš©êµ¬ ìŠ¤íƒ€ì¼)
   - ì„¹ì…˜ 5: ë¯¸ë˜ ì „ë§/ê²°ë¡  (í–¥í›„ ì „ë§ê³¼ CTA)

3. ì£¼ìš” ìƒ‰ìƒ({primary_color})ì„ í™œìš©í•œ ê·¸ë˜ë””ì–¸íŠ¸ì™€ ê°•ì¡° íš¨ê³¼

4. í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:
   - í’ë¶€í•œ CSS ì• ë‹ˆë©”ì´ì…˜ (fade-in, slide-up, count-up ë“±)
   - Chart.jsë¥¼ í™œìš©í•œ ë°ì´í„° ì‹œê°í™”
   - ë°˜ì‘í˜• ë””ìì¸
   - ê³ í’ˆì§ˆ ê·¸ë˜ë””ì–¸íŠ¸ì™€ ê·¸ë¦¼ì íš¨ê³¼
   - ì¸í„°ë™í‹°ë¸Œ í˜¸ë²„ íš¨ê³¼

ì™„ì „í•œ HTML íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”. ëª¨ë“  CSSëŠ” <style> íƒœê·¸ ë‚´ì—, ëª¨ë“  JavaScriptëŠ” <script> íƒœê·¸ ë‚´ì— í¬í•¨í•´ì£¼ì„¸ìš”."""

    try:
        # Claude API í˜¸ì¶œ
        print("ğŸ¤– Claude API í˜¸ì¶œ ì¤‘...")
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=8000,
            temperature=0.7,
            messages=[
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        )
        
        # HTML ì¶”ì¶œ
        html_content = response.content[0].text
        
        # HTML íƒœê·¸ê°€ ì—†ìœ¼ë©´ ë˜í•‘
        if not html_content.strip().startswith('<!DOCTYPE') and not html_content.strip().startswith('<html'):
            html_content = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
</head>
<body>
{html_content}
</body>
</html>"""
        
        return html_content
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    # ëŒ€ê¸° ì¤‘ì¸ ê¸°ì‚¬ ë¡œë“œ
    articles = load_pending_articles()
    
    if len(articles) < 3:
        print("âŒ 3ë²ˆ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # 3ë²ˆ ê¸°ì‚¬ ì„ íƒ (ì „ë‚¨ë„-ì‹œêµ° ESS ì§€ì›ë‹¨)
    article = articles[2]
    print(f"ğŸ“° ì„ íƒëœ ê¸°ì‚¬: {article['title']}")
    
    # ë¹„ìš© ì•ˆë‚´
    print("\nğŸ’° ì˜ˆìƒ ë¹„ìš©: ì•½ $0.555 (750ì›)")
    print("ğŸš€ ìë™ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤...")
    
    # ì¹´ë“œë‰´ìŠ¤ ìƒì„±
    html_content = generate_cardnews_with_claude(article)
    
    if html_content:
        # íŒŒì¼ ì €ì¥
        filename = f"test_comparison/auto_result_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"\nâœ… ì¹´ë“œë‰´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {filename}")
        print(f"ğŸ“Š íŒŒì¼ í¬ê¸°: {len(html_content):,} bytes")
        
        # ë¹„ìš© ê¸°ë¡
        cost_data = {
            "timestamp": datetime.now().isoformat(),
            "article_title": article['title'],
            "cost_usd": 0.555,
            "cost_krw": 750,
            "model": "claude-3-5-sonnet-20241022",
            "test_type": "comparison_test"
        }
        
        # ë¹„ìš© ì¶”ì  íŒŒì¼ ì—…ë°ì´íŠ¸
        cost_file = "cost_tracking.json"
        if os.path.exists(cost_file):
            with open(cost_file, 'r', encoding='utf-8') as f:
                cost_history = json.load(f)
        else:
            cost_history = {"total_cost_usd": 0, "total_cost_krw": 0, "history": []}
        
        cost_history["total_cost_usd"] += cost_data["cost_usd"]
        cost_history["total_cost_krw"] += cost_data["cost_krw"]
        cost_history["history"].append(cost_data)
        
        with open(cost_file, 'w', encoding='utf-8') as f:
            json.dump(cost_history, f, ensure_ascii=False, indent=2)
        
        print(f"ğŸ’° ëˆ„ì  ë¹„ìš©: ${cost_history['total_cost_usd']:.2f} ({cost_history['total_cost_krw']:,}ì›)")
        
        # ê²°ê³¼ ìš”ì•½
        print("\nğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½:")
        print(f"1. ë°˜ìë™ í”„ë¡¬í”„íŠ¸: test_comparison/prompt_semi_auto_*.txt")
        print(f"2. ìë™í™” ê²°ê³¼: {filename}")
        print(f"3. ë‹¤ìŒ ë‹¨ê³„: ë°˜ìë™ ë„êµ¬ì˜ í”„ë¡¬í”„íŠ¸ë¥¼ Claude.aiì— ë³µì‚¬í•˜ì—¬ HTML ìƒì„± í›„ ë¹„êµ")
    else:
        print("âŒ ì¹´ë“œë‰´ìŠ¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
