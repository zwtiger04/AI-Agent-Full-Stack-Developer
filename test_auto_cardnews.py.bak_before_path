#!/usr/bin/env python3
"""
ìë™í™” ì¹´ë“œë‰´ìŠ¤ ìƒì„± í…ŒìŠ¤íŠ¸
"""
import json
import os
from datetime import datetime
from anthropic import Anthropic
from dotenv import load_dotenv

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

def load_pending_articles():
    """ëŒ€ê¸° ì¤‘ì¸ ê¸°ì‚¬ ë¡œë“œ"""
    with open('pending_cardnews.json', 'r', encoding='utf-8') as f:
        return json.load(f)

def generate_cardnews_with_claude(article):
    """Claude APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹´ë“œë‰´ìŠ¤ ìƒì„±"""
    
    # Claude API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    api_key = os.getenv('ANTHROPIC_API_KEY')
    if not api_key:
        print("âŒ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None
    
    client = Anthropic(api_key=api_key)
    
    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    title = article['title']
    keywords = ', '.join(article.get('keywords', []))
    content = article.get('content', '')
    
    # ìƒ‰ìƒ í…Œë§ˆ ê²°ì •
    color_map = {
        'ì¬ìƒì—ë„ˆì§€': '#10B981',
        'íƒœì–‘ê´‘': '#10B981',
        'í’ë ¥': '#10B981',
        'VPP': '#06B6D4',
        'ì „ë ¥ì¤‘ê°œ': '#06B6D4',
        'ESS': '#8B5CF6',
        'ì „ë ¥ì €ì¥': '#8B5CF6',
        'ì „ë ¥ì‹œì¥': '#3B82F6',
        'ì •ì±…': '#3B82F6',
        'ì „ë ¥ë§': '#1E40AF',
        'ì¸í”„ë¼': '#1E40AF'
    }
    
    primary_color = '#3B82F6'  # ê¸°ë³¸ ìƒ‰ìƒ
    for keyword in article.get('keywords', []):
        if keyword in color_map:
            primary_color = color_map[keyword]
            break
    
    prompt = f"""ë‹¹ì‹ ì€ ì „ë ¥ ì‚°ì—… ì „ë¬¸ ì¹´ë“œë‰´ìŠ¤ ë””ìì´ë„ˆì…ë‹ˆë‹¤. ë‹¤ìŒ ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ Enhanced ìŠ¤íƒ€ì¼ì˜ 5í˜ì´ì§€ HTML ì¹´ë“œë‰´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

[ê¸°ì‚¬ ì •ë³´]
ì œëª©: {title}
í‚¤ì›Œë“œ: {keywords}
ë‚´ìš©: {content}
ì£¼ìš” ìƒ‰ìƒ: {primary_color}

[Enhanced ìŠ¤íƒ€ì¼ ê°€ì´ë“œ]
1. Pretendard í°íŠ¸ ì‚¬ìš©
2. 5ê°œ ì„¹ì…˜ êµ¬ì¡°ë¡œ êµ¬ì„±
3. ì£¼ìš” ìƒ‰ìƒì„ í™œìš©í•œ ê·¸ë˜ë””ì–¸íŠ¸ì™€ ê°•ì¡° íš¨ê³¼
4. CSS ì• ë‹ˆë©”ì´ì…˜ê³¼ ì¸í„°ë™í‹°ë¸Œ ìš”ì†Œ í¬í•¨
5. Chart.jsë¥¼ í™œìš©í•œ ë°ì´í„° ì‹œê°í™”
6. ë°˜ì‘í˜• ë””ìì¸

ì™„ì „í•œ HTML íŒŒì¼ì„ ìƒì„±í•´ì£¼ì„¸ìš”. ëª¨ë“  ìŠ¤íƒ€ì¼ê³¼ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¸ë¼ì¸ìœ¼ë¡œ í¬í•¨í•´ì£¼ì„¸ìš”."""

    try:
        # Claude API í˜¸ì¶œ
        print("ğŸ¤– Claude API í˜¸ì¶œ ì¤‘...")
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=8000,
            temperature=0.7,
            messages=[
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        )
        
        # HTML ì¶”ì¶œ
        html_content = response.content[0].text
        
        # HTML íƒœê·¸ê°€ ì—†ìœ¼ë©´ ë˜í•‘
        if not html_content.strip().startswith('<!DOCTYPE') and not html_content.strip().startswith('<html'):
            html_content = f"""<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
</head>
<body>
{html_content}
</body>
</html>"""
        
        return html_content
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    # ëŒ€ê¸° ì¤‘ì¸ ê¸°ì‚¬ ë¡œë“œ
    articles = load_pending_articles()
    
    if len(articles) < 3:
        print("âŒ 3ë²ˆ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    
    # 3ë²ˆ ê¸°ì‚¬ ì„ íƒ (ì „ë‚¨ë„-ì‹œêµ° ESS ì§€ì›ë‹¨)
    article = articles[2]
    print(f"ğŸ“° ì„ íƒëœ ê¸°ì‚¬: {article['title']}")
    
    # ë¹„ìš© í™•ì¸
    print("\nğŸ’° ì˜ˆìƒ ë¹„ìš©: ì•½ $0.555 (750ì›)")
    confirm = input("ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
    
    if confirm.lower() != 'y':
        print("âŒ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        return
    
    # ì¹´ë“œë‰´ìŠ¤ ìƒì„±
    html_content = generate_cardnews_with_claude(article)
    
    if html_content:
        # íŒŒì¼ ì €ì¥
        filename = f"test_comparison/auto_result_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"\nâœ… ì¹´ë“œë‰´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {filename}")
        print(f"ğŸ“Š íŒŒì¼ í¬ê¸°: {len(html_content):,} bytes")
        
        # ë¹„ìš© ê¸°ë¡
        cost_data = {
            "timestamp": datetime.now().isoformat(),
            "article_title": article['title'],
            "cost_usd": 0.555,
            "cost_krw": 750,
            "model": "claude-3-5-sonnet-20241022"
        }
        
        # ë¹„ìš© ì¶”ì  íŒŒì¼ ì—…ë°ì´íŠ¸
        cost_file = "cost_tracking.json"
        if os.path.exists(cost_file):
            with open(cost_file, 'r', encoding='utf-8') as f:
                cost_history = json.load(f)
        else:
            cost_history = {"total_cost_usd": 0, "total_cost_krw": 0, "history": []}
        
        cost_history["total_cost_usd"] += cost_data["cost_usd"]
        cost_history["total_cost_krw"] += cost_data["cost_krw"]
        cost_history["history"].append(cost_data)
        
        with open(cost_file, 'w', encoding='utf-8') as f:
            json.dump(cost_history, f, ensure_ascii=False, indent=2)
        
        print(f"ğŸ’° ëˆ„ì  ë¹„ìš©: ${cost_history['total_cost_usd']:.2f} ({cost_history['total_cost_krw']:,}ì›)")
    else:
        print("âŒ ì¹´ë“œë‰´ìŠ¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()
